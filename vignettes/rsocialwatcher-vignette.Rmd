---
title: "rSocialWatcher"
#author: "Rob Marty"
#date: "`r Sys.Date()`"
#output: rmarkdown::html_vignette
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r init, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Setup

First, we load relevant packages and create variables for our Facebook API keys.

```{r setup, include=TRUE, warning=FALSE, message=FALSE}
## Load Google Traffic package
library(rSocialWatcher)

## Load packages for working with and visualizing data
library(tidyverse)

library(dplyr)
library(lubridate)
library(jsonlite)
library(httr)
library(stringr)

library(knitr)
library(kableExtra)

## Set Facebook Keys
TOKEN        <- "TOKEN-HERE"
CREATION_ACT <- "CREATION-ACT-HERE"
VERSION      <- "VERSION-HERE"
```

```{r loadkey, include=FALSE}
## Load keys
api_keys <- read.csv("~/Dropbox/World Bank/Webscraping/Files for Server/api_keys.csv",
                     stringsAsFactors = F)

api_keys <- api_keys %>%
  dplyr::filter(Service == "facebook_marketing_ad",
                Details == "robmarty3@gmail.com")

TOKEN <- api_keys %>% 
  dplyr::filter(Account == "token") %>% 
  pull(Key)

CREATION_ACT <- api_keys %>% 
  dplyr::filter(Account == "creation_act") %>% 
  pull(Key) %>% 
  str_replace_all("ACT_", "") 

VERSION <- api_keys %>% 
  dplyr::filter(Account == "version") %>% 
  pull(Key)
```

---

# Quickstart

## Example Simple Example

The below example queries the number of Facebook users in the US.

```{r simp_ex, include=TRUE, warning=FALSE, message=FALSE}
df_out <- query_fb_marketing_api(location_unit_type = "countries",
                                 location_key       = "US",
                                 version            = VERSION, 
                                 creation_act       = CREATION_ACT, 
                                 token              = TOKEN)

df_out %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

## Vector as OR; List as Separate Query
The function allows (1). For parameters:.....

* When parameters are in a __vector__, the function treats the parameters as an OR condition. For example, `location_keys = c("US", "MX")` will return the number of Facebook users in the US or Mexico.
* When parameters are in a __list__, the function will loop over the parameters, making separate API calls. For examples, `location_keys = list("US", "MX")` will return a dataframe with two observations; one for the number of Facebook users in the US, then the number of users in Mexico.

__This "vector as OR condition" and "list as separate queries" pattern works across all parameter inputs.__

However, the following parameters can only except one input (a list or vector is not allowed).
* `location_unit_type`
* `radius`
* `radius_unit`

```{r vec_list_1, include=TRUE, warning=FALSE, message=FALSE}
## Number of Users in US or Mexico, as separate queries
df_out <- query_fb_marketing_api(location_unit_type = "countries",
                                 location_key       = c("US", "MX"),
                                 version            = VERSION, 
                                 creation_act       = CREATION_ACT, 
                                 token              = TOKEN)

df_out %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")

## Separate query for number of users in US and Mexico
df_out <- query_fb_marketing_api(location_unit_type = "countries",
                                 location_key       = list("US", "MX"),
                                 version            = VERSION, 
                                 creation_act       = CREATION_ACT, 
                                 token              = TOKEN)

df_out %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

## Example Advanced Query

We want to find the number of Facebook users according to different interests. To grab interest IDs, we use the `get_fb_parameter_ids()` function.

```{r adv_1, include=TRUE, warning=FALSE, message=FALSE}
interests_df <- get_fb_parameter_ids(type = "interests",
                                     version = VERSION,
                                     token = TOKEN) %>%
  arrange(-audience_size_upper_bound) %>%
  dplyr::select(id, name, audience_size_upper_bound)

interests_df %>% 
  head() %>%
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

We are interested in the number of Facebook users interested in:

* Entertainment (id = 6003349442621)
* Music (id = 6003020834693)
* Entertainment or music

And we are interested in the above information for both the US and Mexico

```{r adv_2, include=TRUE, warning=FALSE, message=FALSE}
df_out <- query_fb_marketing_api(location_unit_type = "countries",
                                 location_key       = list("US", "MX"),
                                 interest = list(6003349442621, 6003020834693, 
                                                  c(6003349442621, 6003020834693)),
                                 version            = VERSION, 
                                 creation_act       = CREATION_ACT, 
                                 token              = TOKEN)

df_out %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```


# Querying Location Data using Different Units

Locations can either be specified around a specific coordinate, or using a location type (e.g., country, city, etc.)

## Around a coordinate

```{r coord_1, include=TRUE, warning=FALSE, message=FALSE}
df_out <- query_fb_marketing_api(location_unit_type = "coordinates",
                                 lat_lon            = c(38.90, -77.01),
                                 radius             = 10,
                                 radius_unit        = "kilometer",
                                 version            = VERSION, 
                                 creation_act       = CREATION_ACT, 
                                 token              = TOKEN)

df_out %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

---

## Using a location type/key

### Description of Location Types

We can also query using different location types, including countries, cities, etc. The `get_fb_parameter_ids()` function can be used to extract location keys for different location types; the location keys can then be used in the `query_fb_marketing_api()`. The below table indicates all the location types supported by the package. 

* __Location Type:__ This is specified (1) in the `type` parameter in the `get_fb_parameter_ids()` function and in the `location_unit_type` parameter in the `query_fb_marketing_api()` function
* __Radius Can be Specified:__ For these location types, a radius can optionally be specified; for example, to specify a location and it's surrounding area.
* __US Only:__ These location types can only be used for the US

| Location Type      | Radius Can be Specified | US Only |
| -----------------  | ----------------------  | ------- |
| country_group      | No                      | No      |
| country            | No
| region             |
| large_geo_area     |
| medium_geo_area    |
| small_geo_area     |
| metro_area         |
| city               |
| subcity            |
| neighborhood       |
| subneighborhood    |
| zip                |
| geo_market         |
| electoral_district |

### Example Querying Marketing Data

```{r lockey_1, include=TRUE, warning=FALSE, message=FALSE}

country_df <- get_fb_parameter_ids(type    = "country",
                                   version = VERSION,
                                   token   = TOKEN)

country_df %>%
  head() %>%
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")

df_out <- query_fb_marketing_api(location_unit_type = "countries",
                                 location_keys  = "AD",
                                 version        = VERSION, 
                                 creation_act   = CREATION_ACT, 
                                 token          = TOKEN)


df_out %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

### Examples Querying Location Keys

#### Country Group

#### Country

# Parameter Descriptions



