---
title: "rSocialWatcher"
#author: "Robert Marty"
#date: "`r Sys.Date()`"
#output: rmarkdown::html_vignette
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float: false
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{rSocialWatcher}
  %\VignetteEncoding{UTF-8}
---

```{r init, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Setup <a name="setup"></a>

First, we load relevant packages and create variables for our Facebook API keys.

```{r setup, include=TRUE, warning=FALSE, message=FALSE}
## Load packages
library(rSocialWatcher)
library(tidyverse)
library(dplyr)
library(lubridate)
library(jsonlite)
library(httr)
library(stringr)
library(knitr)
library(kableExtra)
library(leaflet)

## Set Facebook Keys
TOKEN        <- "TOKEN-HERE"
CREATION_ACT <- "CREATION-ACT-HERE"
VERSION      <- "VERSION-HERE"
```

```{r loadkey, include=FALSE}
## Load keys
#api_keys <- read.csv("~/Dropbox/World Bank/Webscraping/Files for Server/api_keys.csv",
#                     stringsAsFactors = F)

api_keys <- read.csv("https://www.dropbox.com/scl/fi/5ug1cfhmoi6v2m393broz/fb_credentials.csv?rlkey=xedl2727l7mnf7ayg0zgrxtr0&dl=1")

api_keys <- api_keys %>%
  dplyr::filter(Service == "facebook_marketing_ad",
                Details == "robmarty3@gmail.com")

TOKEN <- api_keys %>% 
  dplyr::filter(Account == "token") %>% 
  pull(Key)

CREATION_ACT <- api_keys %>% 
  dplyr::filter(Account == "creation_act") %>% 
  pull(Key) %>% 
  str_replace_all("ACT_", "") 

VERSION <- api_keys %>% 
  dplyr::filter(Account == "version") %>% 
  pull(Key)
```

---

The `rSocialWatcher` package provides two functions:

* `get_fb_parameter_ids`: To obtain IDs for targeting users by different characteristics, including different types and by their location.
* `query_fb_marketing_api`: Query daily and monthly active users, querying users for specific locations and by specific types. 

# Querying Parameter IDs <a name="query_param"></a>

The `get_fb_parameter_ids` function facilitates querying IDs to target specific types of users (e.g., users with specific interests) and to target users in specific locations (eg, countries, cities, etc).

## User Type IDs <a name="param_users"></a>

Targeting specific types of users can be done along a number of categories, including by users' interests, behaviors, job, etc. Using the `get_fb_parameter_ids` function, the `type` parameter is used to query IDs for different types of categories. The `type` parameter allows for the following inputs: 

* behaviors 
* demographics 
* interests 
* income 
* industries 
* life_events 
* family_statuses
* locales
* work_positions
* work_employers
* education_statuses
* relationship_statuses
* education_majors
* education_schools

IDs can then be used in the `query_fb_marketing_api` function, which queries daily and monthly active Facebook users. For each `type` input, there is a parameter in the `query_fb_marketing_api` function to include the ID for the specific type. For example, `query_fb_marketing_api` has a parameter for `behaviors` to put behavior IDs. 

```{r simple_dib_ex, include=TRUE, warning=FALSE, message=FALSE}
behaviors_df <- get_fb_parameter_ids(type    = "behaviors",
                                     version = VERSION, 
                                     token   = TOKEN)

behaviors_df %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%",
             height = "300px")

interests_df <- get_fb_parameter_ids(type    = "interests",
                                     version = VERSION, 
                                     token   = TOKEN)

interests_df %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%",
             height = "300px")

job_titles_df <- get_fb_parameter_ids(type    = "work_positions",
                                      version = VERSION, 
                                      token   = TOKEN,
                                      q = "data")

job_titles_df %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%",
             height = "300px")

```

## Location Key <a name="param_locs"></a>

Users can be targeted by different types of [locations](https://developers.facebook.com/docs/marketing-api/audiences/reference/basic-targeting#location), including all users within a country, region (e.g., US state), city, neighborhood, etc. The `get_fb_parameter_ids` is used to obtain the location key for different places. The `type` parameter is used to define the type of location (e.g., `"country"`, `"region"`, etc.). 

In addition to `type`, the `country_code`, `region_id`, `key` and `q` parameters can be used to further refine searchers for locations. Providing an input for `country_code`, `region_id`, and `key` (e.g., city key), will search for locations within those larger locations. Providing an input to the `q` parameter limits the search by name. For smaller geographic regions, an input for `q` is required. 

```{r simple_loc_ex, include=TRUE, warning=FALSE, message=FALSE}
country_group_df <- get_fb_parameter_ids(type    = "country_group",
                                         version = VERSION, 
                                         token   = TOKEN)

country_df <- get_fb_parameter_ids(type    = "country",
                                   version = VERSION, 
                                   token   = TOKEN)

us_states_df <- get_fb_parameter_ids(type    = "region",
                                     version = VERSION, 
                                     token   = TOKEN,
                                     country_code = "US")

ny_key <- us_states_df %>% filter(name == "New York") %>% pull(key) 
ny_cities_df <- get_fb_parameter_ids(type    = "city",
                                     version = VERSION, 
                                     token   = TOKEN,
                                     region_id = ny_key,
                                     q = "New York")

ny_cities_df %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%",
             height = "300px")
```

## Location Key with Coordinates/Geometries <a name="param_locs"></a>

When querying locations using `get_fb_parameter_ids`, setting `add_location_coords` to `TRUE` adds coordinates and, when available, geometries.

```{r cities_coords, include=TRUE, warning=FALSE, message=FALSE}
ny_cities_coords_df <- get_fb_parameter_ids(type    = "city",
                                            version = VERSION, 
                                            token   = TOKEN,
                                            region_id = ny_key,
                                            q = "New York",
                                            add_location_coords = T)

leaflet() %>%
  addTiles() %>%
  addCircles(data = ny_cities_coords_df,
              popup = ~name)
```

# Get coordinates/geometries for location keys <a name="coord_geom"></a>

Above we show that, when using `get_fb_parameter_ids`, coordinates/geometries of locations can be added by setting `add_location_coords` to `TRUE`. However, coordinates/geometries can also be queried using location keys. Retrieving locations/coordinates for many locations can take a long time. Consequently, we may want to (1) use `get_fb_parameter_ids` to obtain location keys, (2) filter keys to relevant keys, then (3) query coordinates/geometries for relevant locations.

For valid location keys, the function will return coordinates (latitude and longitude). When available, the function will also return the geometry. 

Below we show an example for obtaining geometries for Washington, DC zip codes

```{r africa_geom, include=TRUE, warning=FALSE, message=FALSE}
## All Washington, DC zip codes start with 20
zip_df <- get_fb_parameter_ids(type = "zip", 
                               q = "20", 
                               country_code = "US",
                               version = VERSION, 
                               token = TOKEN)

zip_dc_df <- zip_df %>%
  filter(region == "Washington, District of Columbia")

zip_dc_sf <- get_location_coords(location_unit_type = "zip",
                                 location_keys = zip_dc_df$key,
                                 version = VERSION,
                                 token = TOKEN)

leaflet() %>%
  addTiles() %>%
  addPolygons(data = zip_dc_sf,
              popup = ~name)
```

# Querying Data <a name="query_data"></a>

The `query_fb_marketing_api` function enables querying daily and monthly active users for specific locations and by specific types. Many parameters rely on IDs obtained from the `get_fb_parameter_ids` function. For example, `get_fb_parameter_ids` can be used to obtain the location key for New York City and the interest parameter ID for "Music (entertainment & media)"; these IDs can then be used in `query_fb_marketing_api` to obtain the number of Facebook users interested in music that live in New York City.

## Different Location Types <a name="query_data_loc"></a>

The number of daily and monthly active Facebook users can be queried (1) around a specific point (setting the latitude and longitude and the radius around this point), and (2) for a specific geographic (e.g., country, region, city, neighborhood, etc.). For small geographies, such as neighborhoods, a radius can also be set. 

### Radius around lat/lon <a name="query_data_loc_latlon"></a>

```{r simple_query_latlon_ex, include=TRUE, warning=FALSE, message=FALSE}

## All Facebook Users by Radius (Near NYC)
r5km_df <- query_fb_marketing_api(location_unit_type = "coordinates",
                                  lat_lon            = c(40.712, -74.006),
                                  radius             = 5,
                                  radius_unit        = "kilometer",
                                  version            = VERSION, 
                                  creation_act       = CREATION_ACT, 
                                  token              = TOKEN)
```

### Location IDs - Country, State, District, City, Neighborhood, etc. <a name="query_data_loc_keys"></a>

We can also query using different location types, including countries, cities, etc. The `get_fb_parameter_ids()` function can be used to extract location keys for different location types; the location keys can then be used in the `query_fb_marketing_api()`. The below table indicates all the location types supported by the package.

* __Location Type:__ This is specified (1) in the `type` parameter in the `get_fb_parameter_ids()` function and in the `location_unit_type` parameter in the `query_fb_marketing_api()` function
* __Radius Can be Specified:__ For these location types, a radius can optionally be specified; for example, to specify a location and it's surrounding area.
* __US Only:__ These location types can only be used for the US

| Location Type      | Radius Can be Specified | US Only | Example |
| -----------------  | ----------------------  | ------- | ------- |
| country_group      | No                      | No      | World Wide
| country            | No                      | No      | United States|
| region             | No                      | No      | New York |
| large_geo_area     | No                      | No      | Akkar, Lebanon |
| medium_geo_area    | No                      | No      | Henrico County, Virginia, USA |
| small_geo_area     | No                      | No      | El Rosario, Spain |
| city               | Yes                     | No      | New York City |
| subcity            | No                      | No      | Manhattan
| neighborhood       | No                      | No      | East Village, Manhattan |
| zip                | No                      | Yes     | 90210 |
| geo_market         | No                      | Yes     | New York| 
| electoral_district | No                      | Yes     | New York's 18th District, 2020 Census |

Below shows examples for querying Facebook users for each type of location type. Note that when entering the `type` in `get_fb_parameter_ids`, the __singular__ is used (e.g., `"country"`), while when entering the `type` in `query_fb_marketing_api`, the __plural__ is used (e.g., `"countries"`). Using the singular type to obtain the IDs and the plural to query the number of Facebook users mimics how parameters are entered in the Facebook Marketing API.

#### Country Groups <a name="query_data_loc_keys_country_groups"></a>

```{r loc_country_group, include=TRUE, warning=FALSE, message=FALSE}

#### Country Group: World Wide
loc_df <- get_fb_parameter_ids(type = "country_group", 
                               version = VERSION, token = TOKEN)

query_fb_marketing_api(
  location_unit_type = "country_groups",
  location_keys      = loc_df %>% 
    filter(name == "Worldwide") %>% 
    pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

#### Country <a name="query_data_loc_keys_country"></a>

```{r loc_country, include=TRUE, warning=FALSE, message=FALSE}
#### Country: United States
loc_df <- get_fb_parameter_ids(type = "country", 
                               version = VERSION, token = TOKEN)

query_fb_marketing_api(
  location_unit_type = "countries",
  location_keys      = loc_df %>% 
    filter(name == "United States") %>% 
    pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

#### Region <a name="query_data_loc_keys_region"></a>

```{r loc_region, include=TRUE, warning=FALSE, message=FALSE}

#### Region: New York (state)
region_df <- get_fb_parameter_ids(type = "region", country_code = "US", 
                                  version = VERSION, token = TOKEN)

query_fb_marketing_api(
  location_unit_type = "regions",
  location_keys      = region_df %>% 
    filter(name == "New York") %>% 
    pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

#### Large Geographic Area <a name="query_data_loc_keys_lga"></a>

The Facebook Marketing [Targeting Search](https://developers.facebook.com/docs/marketing-api/audiences/reference/targeting-search) provides the following description about large geographic areas: _"Known commonly as a district or governate covering hundreds of square kilometers or more. Example: Akkar in Lebanon."_

```{r loc_lga, include=TRUE, warning=FALSE, message=FALSE}

#### Large Metro Area
loc_df <- get_fb_parameter_ids(type = "large_geo_area", 
                               country_code = "LB", 
                               q = "Akkar",
                               version = VERSION, token = TOKEN)

query_fb_marketing_api(
  location_unit_type = "large_geo_areas",
  location_keys      = loc_df %>% 
    filter(name == "Akkar") %>% 
    pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

#### Medium Geographic Area <a name="query_data_loc_keys_mga"></a>

The Facebook Marketing [Targeting Search](https://developers.facebook.com/docs/marketing-api/audiences/reference/targeting-search) provides the following description about medium geographic areas: _"Known commonly as a county, covering more than one city. Example: Henrico county in the state of Virginia in United States."_

```{r loc_mga, include=TRUE, warning=FALSE, message=FALSE}

#### Large Metro Area
loc_df <- get_fb_parameter_ids(type = "medium_geo_area", 
                               country_code = "US", 
                               q = "Henrico",
                               version = VERSION, token = TOKEN)

query_fb_marketing_api(
  location_unit_type = "medium_geo_areas",
  location_keys      = loc_df %>% 
    filter(name == "Henrico") %>% 
    pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

#### Small Geographic Area <a name="query_data_loc_keys_sga"></a>

The Facebook Marketing [Targeting Search](https://developers.facebook.com/docs/marketing-api/audiences/reference/targeting-search) provides the following description about small geographic areas: _"Known commonly as a residential area near a city or town. Example: El Rosario near Marbella in Spain."_

```{r loc_sga, include=TRUE, warning=FALSE, message=FALSE}

#### Large Metro Area
loc_df <- get_fb_parameter_ids(type = "small_geo_area", 
                               country_code = "ES", 
                               q = "El",
                               version = VERSION, token = TOKEN)

query_fb_marketing_api(
  location_unit_type = "small_geo_areas",
  location_keys      = loc_df %>% 
    filter(name == "El Rosario") %>% 
    pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

#### City <a name="query_data_loc_keys_city"></a>

```{r loc_city, include=TRUE, warning=FALSE, message=FALSE}
#### City: New York City
loc_df <- get_fb_parameter_ids(type = "city", 
                               region_id = region_df %>% 
                                 filter(name == "New York") %>% 
                                 pull(key),
                               q = "New York",
                               version = VERSION, token = TOKEN)

## Facebook users in NYC
query_fb_marketing_api(
  location_unit_type = "cities",
  location_keys      = loc_df %>% filter(name == "New York") %>% pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")

## Facebook users in and 10 miles around NYC
city_r_df <- query_fb_marketing_api(
  location_unit_type = "cities",
  location_keys      = loc_df %>% filter(name == "New York") %>% pull(key),
  radius             = 10,
  radius_unit        = "mile",
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

#### Subcity <a name="query_data_loc_keys_subcity"></a>

```{r loc_subcity, include=TRUE, warning=FALSE, message=FALSE}
#### Subcity: Manhattan
loc_df <- get_fb_parameter_ids(type = "subcity", 
                               region_id = region_df %>% 
                                 filter(name == "New York") %>% 
                                 pull(key),
                               q = "Manhattan",
                               version = VERSION, token = TOKEN)

query_fb_marketing_api(
  location_unit_type = "subcities",
  location_keys      = loc_df %>% filter(name == "Manhattan") %>% pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

#### Neighborhood <a name="query_data_loc_keys_neighborhood"></a>

```{r loc_neighborhood, include=TRUE, warning=FALSE, message=FALSE}
loc_df <- get_fb_parameter_ids(type = "neighborhood", 
                               region_id = region_df %>% 
                                 filter(name == "New York") %>% 
                                 pull(key),
                               q = "East Village",
                               version = VERSION, token = TOKEN)

query_fb_marketing_api(
  location_unit_type = "neighborhoods",
  location_keys      = loc_df %>% 
    filter(name == "East Village, Manhattan") %>% 
    pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

#### Zip Code <a name="query_data_loc_keys_zipcode"></a>

```{r loc_zip, include=TRUE, warning=FALSE, message=FALSE}
## Zip codes can be directly entered as "US:[Zip Code]"
query_fb_marketing_api(
  location_unit_type = "zips",
  location_keys      = "US:90210",
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")

## Zip codes can also be searched for using: "get_fb_parameter_ids"
loc_df <- get_fb_parameter_ids(type = "zip", 
                               q = "9", # Search using numbers
                               version = VERSION, token = TOKEN)

query_fb_marketing_api(
  location_unit_type = "zips",
  location_keys      = loc_df %>% filter(name == "90210") %>% pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

#### Geo Market (U.S. Designated Market Areas) <a name="query_data_loc_keys_geo_market"></a>

```{r loc_geo_market, include=TRUE, warning=FALSE, message=FALSE}
loc_df <- get_fb_parameter_ids(type = "geo_market", 
                               version = VERSION, token = TOKEN)

query_fb_marketing_api(
  location_unit_type = "geo_markets",
  location_keys      = loc_df %>% 
    filter(name == "New York") %>% 
    pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

#### Electoral Districts <a name="query_data_loc_keys_electoral"></a>

```{r loc_elec_dist, include=TRUE, warning=FALSE, message=FALSE}
loc_df <- get_fb_parameter_ids(type = "electoral_district", 
                               q = "New York", 
                               version = VERSION, token = TOKEN)

query_fb_marketing_api(
  location_unit_type = "electoral_districts",
  location_keys      = loc_df %>% 
    filter(name == "New York's 18th District - 2020 Census") %>% 
    pull(key),
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN) %>%
  kable() %>% 
  kable_styling() %>%
  scroll_box(width = "100%")
```

## Querying data using parameter IDs <a name="query_data_ids"></a>

### Using one parameter ID per parameter type <a name="query_data_ids_options"></a>

We use parameter IDs to query the number of Facebook users by behaviors, interests, etc. Below we show examples querying data by behaviors and interests. An OR condition is used when parameters are entered for multiple parameter types. For example, the third example shows querying users by a behavior and an interest---setting a value in `query_fb_marketing_api` for the `behaviors` (commuters) and `interests` (music) parameters. In this case, the function determines the number of Facebook users that are commuters OR have an interest in music.

```{r simple_query_params_ex, include=TRUE, warning=FALSE, message=FALSE}

# Likely commute to work in US
beh_comm_id <- behaviors_df %>% filter(name == "Commuters") %>% pull(id)
comm_us_df <- query_fb_marketing_api(location_unit_type = "countries",
                                     location_keys      = "US",
                                     behaviors          = beh_comm_id,
                                     version            = VERSION, 
                                     creation_act       = CREATION_ACT, 
                                     token              = TOKEN)

# Interested in music in US
int_music_id <- interests_df %>% filter(name == "Music (entertainment & media)") %>% pull(id)
music_us_df <- query_fb_marketing_api(location_unit_type = "countries",
                                      location_keys      = "US",
                                      interests          = int_music_id,
                                      version            = VERSION, 
                                      creation_act       = CREATION_ACT, 
                                      token              = TOKEN)

# Likely commute to work OR interested in music in US
comm_or_music_us_df <- query_fb_marketing_api(location_unit_type = "countries",
                                              location_keys      = "US",
                                              behaviors          = beh_comm_id,
                                              interests          = int_music_id,
                                              version            = VERSION, 
                                              creation_act       = CREATION_ACT, 
                                              token              = TOKEN)
```

### And and OR Categories <a name="query_data_ids_andor"></a>

The function allows for specifying `and` and `or` conditions; for example, identifying Facebook users that are commuters and/or are frequent travelers. Vectors and lists are used to distinguish between AND and OR conditions:

* __Vectors `c()`__ are used to specify OR conditions
* __Lists `list()`__ are used to specify AND conditions

However, the following parameters can only except one input (a list or vector is not allowed).

* `location_unit_type`
* `radius`
* `radius_unit`

#### Within parameter types <a name="query_data_ids_andor_within"></a>

To specify AND or OR conditions for the same parameter type:

* Enter multiple parameter IDs within vectors to specify OR conditions
* Enter multiple parameter IDs within lists to specify AND conditions

```{r and_or_within, include=TRUE, warning=FALSE, message=FALSE}

beh_freqtrvl_id  <- behaviors_df %>% filter(name == "Frequent Travelers") %>% pull(id)
beh_comm_id      <- behaviors_df %>% filter(name == "Commuters") %>% pull(id)
beh_sb_id        <- behaviors_df %>% filter(name == "Small business owners") %>% pull(id)

# Users who are: Commuters or Travelers
comm_or_trvl_df <- query_fb_marketing_api(location_unit_type = "countries",
                                          location_keys      = "US",
                                          behaviors          = c(beh_comm_id, beh_freqtrvl_id),
                                          version            = VERSION, 
                                          creation_act       = CREATION_ACT, 
                                          token              = TOKEN)

# Users who are: Commuters and Travelers
comm_or_trvl_df <- query_fb_marketing_api(location_unit_type = "countries",
                                          location_keys      = "US",
                                          behaviors          = list(beh_comm_id, beh_freqtrvl_id),
                                          version            = VERSION, 
                                          creation_act       = CREATION_ACT, 
                                          token              = TOKEN)

# Users who are (Commuters or Small Business Owners) and Travelers
comm_and_trvl_df <- query_fb_marketing_api(location_unit_type = "countries",
                                           location_keys      = "US",
                                           behaviors          = list(c(beh_comm_id,
                                                                       beh_sb_id), 
                                                                     beh_freqtrvl_id),
                                           version            = VERSION, 
                                           creation_act       = CREATION_ACT, 
                                           token              = TOKEN)
```

#### Across parameter types: Flexible Targetting <a name="query_data_ids_andor_flex"></a>

Flexible tagetting, using the `flex_target` parameter, allows for more complicated parameter specification---including AND conditions across parameter types (eg, behavior X AND interest Y). The input for `flex_target` follows the following logic:

* `flex_target` uses named lists to specify the (1) parameter type and (2) parameter ID
* All parameters within the same list index are grouped using an OR condition
* All parameter separated across list indices are spearated by an AND condition

The below shows examples using dummy IDs

__Example 1: OR Condition__
The below shows an example setting an OR condition for interest ID 2 and behavior ID 2. Both interest:1 and behavior:2 are in the same list index, so are grouped using an OR condition (interests:1 OR behavior 2)
```
flex_param <- list("interests" = 1, "behaviors" = 2)
# flex_param[[1]]
```

__Example 2: AND Condition__
The below shows an example setting an AND condition for interest ID 2 and behavior ID 2. interest:1 and behavior:2 are separated across list indices, so are separated by an AND condition (interests:1 AND behavior:2)
```
flex_param <- list(list("interests" = 1), list("behaviors" = 2))
# flex_param[[1]] AND flex_param[[2]]
```

__Example 3: OR and AND Conditions__
The below shows a more complicated example, which grabs all users that meet (EITHER interests:1 or behaviors:3) AND (behaviors:2). Everything within `flex_param[[1]]` are grouped within OR conditions, but different indices (`flex_param[[1]]` and `flex_param[[2]]`) are separated by AND conditions.
```
flex_param <- list(list("interests" = 1, "behaviors" = 3), list("behaviors" = 2))
# flex_param[[1]] AND flex_param[[2]]
```

```{r and_or_across, include=TRUE, warning=FALSE, message=FALSE}

int_music_id <- interests_df %>% filter(name == "Music (entertainment & media)") %>% pull(id)
beh_comm_id  <- behaviors_df %>% filter(name == "Commuters") %>% pull(id)

## OR CONDITION
comm_or_music_df <- query_fb_marketing_api(location_unit_type = "countries",
                                           location_keys      = "US",
                                           flex_target        = list("interests" = int_music_id,
                                                                     "behaviors" = beh_comm_id),
                                           version            = VERSION, 
                                           creation_act       = CREATION_ACT, 
                                           token              = TOKEN)

## AND CONDITION
comm_and_music_df <- query_fb_marketing_api(location_unit_type = "countries",
                                            location_keys      = "US",
                                            flex_target        = list(list("interests" = int_music_id),
                                                                      list("behaviors" = beh_comm_id)),
                                            version            = VERSION, 
                                            creation_act       = CREATION_ACT, 
                                            token              = TOKEN)

bind_rows(comm_or_music_df,
          comm_and_music_df) %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%",
             height = "100%")

```

### Exlcuding Categories <a name="query_data_ids_exclude"></a>

Many parameters come with an alternate input that starts with `excl_` to exclude types of users. For example, there are both `behaviors` and `interests` parameters, as well as `excl_behaviors` and `excl_interests` parameters. The below code shows an example querying users who likely commute to work and are not tagged as interested in music.

```{r exclude_ex, include=TRUE, warning=FALSE, message=FALSE}

# Likely commute to work BUT NOT interested in music in US
beh_comm_id  <- behaviors_df %>% filter(name == "Commuters") %>% pull(id)
int_music_id <- interests_df %>% filter(name == "Music (entertainment & media)") %>% pull(id)

comm_no_music_us_df <- query_fb_marketing_api(location_unit_type = "countries",
                                              location_keys      = "US",
                                              behaviors          = beh_comm_id,
                                              excl_interests     = int_music_id,
                                              version            = VERSION, 
                                              creation_act       = CREATION_ACT, 
                                              token              = TOKEN)
```


## Multiple Queries <a name="query_data_ids_multquery"></a>

The function allows making multiple queries within one function call. All parameters in the `map_param` function will be iterated as separate calls. For example, when `location_unit_type = "countries"`, `location_key = map_param("US", "MX")` will make one query for the US, and a second query for Mexico.

Note that `map_param` simply creates a list where each item entered into `map_param` becomes a different item in the list. In addition, the `map_param` assigns the first value of this list as the string `"map_param"`, which is used within the function to indicate that a seprate query should be made for each item in the list. 

More generally, for any `list` or `vector` where the first element of the `list` or `vector` is `map_param`, separate queries will be made for additional elements. 

Below shows examples. Assume hat we are using `map_param` to create separate queries for interests, for interest ID `1` and `2`.

__Example 1: Simple example,__ making one query to determing the number of users with an interest in `1`, and a separate query to determine the number of users with an interest in `2`.
```{r map_param_ex1, include=TRUE, warning=FALSE, message=FALSE}
map_param(1, 2)
```

__Example 2: Note that below will only make one query,__ querying users with an interest in 1 OR 2. The first item in the list is `"map_param`, indicating that the next items should be made in separate queries. However, there is only one separate item: `c(1,2)` -- which the function interprets using an `OR` condition.
```{r map_param_ex2, include=TRUE, warning=FALSE, message=FALSE}
interests_vec <- c(1, 2)

map_param(interests_vec)
```

__Example 3: To map over a vector,__ we can use the following code. 
```{r map_param_ex3, include=TRUE, warning=FALSE, message=FALSE}
interests_vec <- c(1, 2)

map_param(interests_vec) %>% unlist()
```

### Simple Examples <a name="query_data_ids_multquery_simple"></a>

Below we show simple examples using `map_param`.

```{r vec_list_1, include=TRUE, warning=FALSE, message=FALSE}
## Number of Users in US or Mexico, as separate queries
df_out <- query_fb_marketing_api(location_unit_type = "countries",
                                 location_key       = map_param("US", "MX"),
                                 version            = VERSION, 
                                 creation_act       = CREATION_ACT, 
                                 token              = TOKEN)

df_out %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")

## Iterate across countries and across behaviors. Use `NA` for not filtering by behavior. The below call will give users for (1) all US, (2) all Mexico, (3) frequent travelers in US, and (4) frequenty travelers in Mexico.
df_out <- query_fb_marketing_api(location_unit_type = "countries",
                                 location_key       = map_param("US", "MX"),
                                 behaviors          = map_param(NA, beh_freqtrvl_id),
                                 version            = VERSION, 
                                 creation_act       = CREATION_ACT, 
                                 token              = TOKEN)

df_out %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")

## Separate query for number of users in US and Mexico and commuters and frequent travelers. Parameters not in
## map_param are applied across all queries. 
beh_comm_id      <- behaviors_df %>% filter(name == "Commuters") %>% pull(id)
beh_freqtrvl_id  <- behaviors_df %>% filter(name == "Frequent Travelers") %>% pull(id)
beh_sb_id        <- behaviors_df %>% filter(name == "Small business owners") %>% pull(id)
int_music_id     <- interests_df %>% filter(name == "Music (entertainment & media)") %>% pull(id)

df_out <- query_fb_marketing_api(location_unit_type = "countries",
                                 location_key       = map_param("US", "MX"),
                                 behaviors          = map_param(beh_comm_id, beh_freqtrvl_id),
                                 interests          = int_music_id,
                                 version            = VERSION, 
                                 creation_act       = CREATION_ACT, 
                                 token              = TOKEN)

df_out %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```

### And/Or Conditions <a name="query_data_ids_multquery_andor"></a>

And/or conditions work as before: vectors `c()` specify OR conditions, while lists `list()` specify and conditions.

```{r vec_list_1_andor, include=TRUE, warning=FALSE, message=FALSE}

beh_freqtrvl_id  <- behaviors_df %>% filter(name == "Frequent Travelers") %>% pull(id)
beh_comm_id      <- behaviors_df %>% filter(name == "Commuters") %>% pull(id)
beh_sb_id        <- behaviors_df %>% filter(name == "Small business owners") %>% pull(id)

df_out <- query_fb_marketing_api(
  location_unit_type = "countries",
  location_key       = "US",
  behaviors          = map_param(
    # Commuters
    beh_comm_id, 
    
    # Frequent Travelers
    beh_freqtrvl_id, 
    
    # Commuters OR Frequent Travelers
    c(beh_comm_id, beh_freqtrvl_id),
    
    # Commuters AND Frequent Travelers
    list(beh_comm_id, beh_freqtrvl_id),
    
    # Commuters AND (Frequent Travelers OR Small Business Owners)
    list(beh_comm_id, c(beh_freqtrvl_id, beh_sb_id))
  ),
  
  version            = VERSION, 
  creation_act       = CREATION_ACT, 
  token              = TOKEN)

df_out %>% 
  kable() %>% 
  kable_styling() %>% 
  scroll_box(width = "100%")
```
